<html layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">
<div layout:fragment="content">
    <div class="px-5 space-y-10">
        <div>
            <div class="space-y-1 border-b pb-3">
                <div class="text-4xl font-bold" th:text="${chord.song}"></div>
                <div class="text-zinc-500" th:text="${chord.artist}"></div>
            </div>

            <div class="flex justify-between pt-2">
                <div class="flex items-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                         class="size-6">
                        <path fill-rule="evenodd"
                              d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.99 5.99 0 0 0-4.793 2.39A6.483 6.483 0 0 0 10 16.5a6.483 6.483 0 0 0 4.793-2.11A5.99 5.99 0 0 0 10 12Z"
                              clip-rule="evenodd"/>
                    </svg>
                    <div th:if="${chord.author != null}" th:text="${chord.author.username}" class="text-sm"></div>
                </div>

                <!--코드 수정/삭제 버튼-->
                <div sec:authorize="isAuthenticated()"
                     th:if="${chord.author != null and #authentication.getPrincipal().getUsername() == chord.author.username}"
                     class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                             class="size-5">
                            <path d="M3 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM8.5 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM15.5 8.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z"/>
                        </svg>
                    </div>
                    <ul tabindex="0"
                        class="dropdown-content menu bg-base-100 rounded-box z-[1] w-[73px] p-2 shadow">
                        <li>
                            <a th:href="@{|/chord/edit/${chord.id}|}"
                               th:text="수정">
                            </a>
                        </li>
                        <li>
                            <button type="button" onclick="deleteMethod(this)"
                                    th:data-uri="@{|/chord/delete/${chord.id}|}"
                                    th:text="삭제">
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="py-20" th:text="${chord.content}"></div>

        <div class="flex justify-between border rounded-lg p-3">
            <!--등록일, 수정일-->
            <div class="flex space-x-1">
                <div class="flex flex-col items-center justify-center bg-base-200 rounded-lg text-xs text-black py-2 px-3 space-y-0.5 tracking-wider">
                    <div>등록</div>
                    <div th:if="${chord.createAt != null}"
                         th:text="${#temporals.format(chord.createAt, 'yyyy.MM.dd')}"></div>
                </div>

                <div th:if="${chord.updateAt != null}"
                     class="flex flex-col items-center justify-center bg-base-200 rounded-lg text-xs text-black py-2 px-3 space-y-0.5 tracking-wider">
                    <div>수정</div>
                    <div th:text="${#temporals.format(chord.updateAt, 'yyyy.MM.dd')}"></div>
                </div>
            </div>

            <!--좋아요-->
            <div class="flex flex-col items-center justify-center space-y-2">
                <a th:id="|vote_${chord.id}|"></a>
                <div class="badge badge-outline border-neutral-400" th:text="${#lists.size(chord.voter)}"></div>

                <div onclick="handleVote(this)"
                     th:attr="uri=@{|/chord/vote/${chord.id}|}"
                     class="recommend p-3 rounded-full hover:bg-base-200 active:scale-90 duration-100">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                        <path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 1 1-2.5 0v-7.5ZM11 3V1.7c0-.268.14-.526.395-.607A2 2 0 0 1 14 3c0 .995-.182 1.948-.514 2.826-.204.54.166 1.174.744 1.174h2.52c1.243 0 2.261 1.01 2.146 2.247a23.864 23.864 0 0 1-1.341 5.974C17.153 16.323 16.072 17 14.9 17h-3.192a3 3 0 0 1-1.341-.317l-2.734-1.366A3 3 0 0 0 6.292 15H5V8h.963c.685 0 1.258-.483 1.612-1.068a4.011 4.011 0 0 1 2.166-1.73c.432-.143.853-.386 1.011-.814.16-.432.248-.9.248-1.388Z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 댓글 작성 폼 -->
        <form th:action="@{|/comment/create/${chord.id}|}"
              method="post"
              th:object="${commentCreateForm}"
              class="flex flex-col items-end space-y-3"
        >
            <div th:replace="~{fragments/form_errors :: formErrorsFragment}"></div>

            <!--로그아웃 상태면 작성불가능-->
            <textarea
                    sec:authorize="isAnonymous()" disabled
                    th:field="*{commentContent}"
                    class="textarea textarea-bordered w-full h-40 min-h-40 max-h-80"
                    placeholder="댓글을 남겨보세요!"
                    name="commentContent"
                    rows="15">
            </textarea>

            <!--로그인 상태면 작성가능-->
            <textarea
                    sec:authorize="isAuthenticated()"
                    th:field="*{commentContent}"
                    class="textarea textarea-bordered w-full h-40 min-h-40 max-h-80"
                    placeholder="댓글을 남겨보세요!"
                    name="commentContent"
                    rows="15">
            </textarea>

            <input class="btn" type="submit" value="등록"/>
        </form>

        <!-- 댓글 목록 -->
        <div class="space-y-3">
            <div th:text="|${#lists.size(chord.comments)}개의 댓글|"></div>

            <!-- 댓글이 없을 경우 -->
            <div th:if="${#lists.isEmpty(chord.comments)}"
                 class="flex bg-zinc-50 text-[15px] text-gray-500 justify-center items-center p-5 rounded-lg h-40">
                댓글이 없습니다.
            </div>

            <!-- 댓글이 있을 경우 -->
            <div th:each="comment: ${chord.comments}" class="border rounded-lg p-5">
                <a th:id="|comment_${comment.id}|"></a>

                <div class="flex justify-end space-x-1">
                    <!-- 댓글에 데이터 속성을 추가해서 chord.id와 comment.id 값을 넣어줌 -->
                    <button class="btn btn-sm tracking-wide"
                            th:attr="chordId=${chord.id}, commentId=${comment.id}"
                    >답글달기
                    </button>

                    <!--댓글 수정/삭제 버튼-->
                    <div sec:authorize="isAuthenticated()"
                         th:if="${comment.author != null and #authentication.getPrincipal().getUsername() == comment.author.username}"
                         class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                 class="size-5">
                                <path d="M3 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM8.5 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM15.5 8.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z"/>
                            </svg>
                        </div>
                        <ul tabindex="0"
                            class="dropdown-content menu bg-base-100 rounded-box z-[1] w-[73px] p-2 shadow">
                            <li>
                                <div onclick="editCommentGet(this)"
                                     th:attr="commentId=${comment.id}"
                                >
                                    수정
                                </div>
                            </li>
                            <li>
                                <button type="button" onclick="deleteMethod(this)"
                                        th:data-uri="@{|/comment/delete/${comment.id}|}"
                                        th:text="삭제">
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="chat chat-start space-y-1">
                    <div class="chat-header flex ml-1 items-center space-x-1">
                        <div th:if="${comment.author != null}" th:text="${comment.author.username}"
                             class="text-[14px]"></div>

                        <time th:if="${comment.updateAt != null}"
                              th:text="|${@dateTimeUtil.getTimeAgo(comment.updateAt)} 수정됨|"
                              class="text-xs opacity-50"></time>

                        <time th:if="${comment.updateAt == null}"
                              th:text="${@dateTimeUtil.getTimeAgo(comment.createdAt)}"
                              class="text-xs opacity-50"></time>
                    </div>
                    <div th:text="${comment.content}" class="chat-bubble text-[15px] flex items-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 댓글 수정 모달 -->
    <dialog id="editComment" class="modal">
        <div class="modal-box">
            <div class="border-b pb-1.5">
                <div class="font-semibold">댓글 수정</div>
            </div>

            <!-- 댓글 내용을 입력받는 textarea -->
            <div class="py-5">
                <textarea id="editCommentContent" name="commentContent" rows="10"
                          class="textarea textarea-bordered w-full h-40 min-h-40 max-h-80"></textarea>
            </div>

            <div class="flex justify-end items-end space-x-2">
                <form method="dialog">
                    <button class="btn">취소</button>
                </form>

                <!-- 저장 버튼 -->
                <input type="button" value="저장하기"
                       id="saveEditCommentButton"
                       onclick="editCommentPost(this)"
                       class="btn btn-neutral"
                >
            </div>
        </div>
    </dialog>

    <script>
        function deleteMethod(element) {
            const uri = element.dataset.uri;

            if (confirm("정말 삭제하시겠습니까?")) {
                location.href = uri
            }
        }

        function editCommentGet(element) {
            const commentId = element.getAttribute('commentId');

            // 서버에 POST 요청을 보냄 (데이터 받아오기)
            fetch(`/comment/edit/${commentId}`, {
                method: 'GET', // POST 방식으로 변경 가능
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value  // CSRF 토큰 추가
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok'); // 에러 처리
                    }
                    return response.json();  // JSON으로 변환
                })
                .then(data => {
                    // 응답 데이터를 모달 안의 textarea에 표시
                    document.getElementById('editCommentContent').value = data.commentContent;

                    // 저장 버튼에 commentId를 data-comment-id 속성으로 설정
                    const saveButton = document.getElementById('saveEditCommentButton');
                    saveButton.setAttribute('data-comment-id', commentId);

                    // 모달 열기 (데이터 설정 후 모달 열기)
                    document.getElementById('editComment').showModal();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('댓글을 불러오는 중 오류가 발생했습니다.');
                });
        }

        function editCommentPost(element) {
            const commentId = element.getAttribute('data-comment-id');
            const commentContent = document.getElementById('editCommentContent').value;

            // 동적으로 폼을 생성하여 서버에 POST 요청
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/comment/edit/${commentId}`;

            // CSRF 토큰 추가
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = document.querySelector('input[name="_csrf"]').value;
            form.appendChild(csrfInput);

            // 댓글 내용 추가
            const contentInput = document.createElement('textarea');
            contentInput.name = 'commentContent';
            contentInput.value = commentContent;
            form.appendChild(contentInput);

            // 폼을 body에 추가한 후, submit
            document.body.appendChild(form);
            form.submit();
        }

        function handleVote(element) {
            const uri = element.getAttribute('uri');
            location.href = uri
        }
    </script>
</div>
</html>
